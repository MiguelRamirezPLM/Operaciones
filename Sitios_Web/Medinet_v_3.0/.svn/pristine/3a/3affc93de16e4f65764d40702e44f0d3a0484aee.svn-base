using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using Web.Models.Sessions;
using Web.Models;

namespace Web.Controllers.Medical
{
    public class MedicalController : Controller
    {

        Medinet db = new Medinet();

        public ActionResult Index()
        {
            if (!Request.IsAuthenticated)
            {
                return RedirectToAction("Logout", "Login");
            }

            return View();
        }

        public ActionResult Content(int? CId, int? DId)
        {
            if (!Request.IsAuthenticated)
            {
                return RedirectToAction("Logout", "Login");
            }

            List<plm_spGetProductsbyDivisionbyCountry_Result> LS = db.Database.SqlQuery<plm_spGetProductsbyDivisionbyCountry_Result>("plm_spGetProductsbyDivisionbyCountry @CountryId=" + CId + ", @DivisionId=" + DId + "").Take(50).ToList();


            SessionM SessionM = new SessionM(Convert.ToInt32(CId), 1, 1, 1, Convert.ToInt32(DId));
            Session["SessionM"] = SessionM;

            return View(LS);
        }

        public JsonResult UpdateProductType(string Product, string ProductType)
        {
            int ProductId = int.Parse(Product);
            byte ProductTypeId = Convert.ToByte(ProductType);

            List<Products> LP = db.Products.Where(x => x.ProductId == ProductId).ToList();

            if (LP.LongCount() > 0)
            {
                foreach (Products _p in LP)
                {
                    _p.ProductTypeId = ProductTypeId;

                    db.SaveChanges();
                }
            }

            return Json(true, JsonRequestBehavior.AllowGet);
        }

        public JsonResult GetLaboratories(string id)
        {
            int CountryId = int.Parse(id);

            List<Divisions> LS = db.Database.SqlQuery<Divisions>("plm_spGetDivisionsByCountry @countryId=" + CountryId + "").ToList();

            return Json(LS, JsonRequestBehavior.AllowGet);
        }

    }
}